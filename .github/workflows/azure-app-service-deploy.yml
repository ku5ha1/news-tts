name: Deploy to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # VM Configuration
  VM_HOST: ${{ secrets.VM_HOST }}
  VM_USERNAME: ${{ secrets.VM_USERNAME }}
  IMAGE_NAME: news-tts
  
  # Environment Variables - Using app user's cache directory
  HF_HOME: /home/app/.cache/huggingface
  TRANSFORMERS_CACHE: /home/app/.cache/huggingface
  HF_HUB_OFFLINE: 0
  TRUST_REMOTE_CODE: 1
  LOG_LEVEL: info
  PORT: 8080
  PYTHONUNBUFFERED: 1
  
  # Service Configuration
  TRANSLATION_PER_CALL_TIMEOUT: 90
  TRANSLATION_PER_CALL_TIMEOUT_RETRY: 120

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          # Navigate to project directory
          cd ~/news-tts
          
          # Stash local changes and pull latest changes
          git stash || true
          git pull origin main
          
          # Stop existing container
          docker stop news-tts-container || true
          docker rm news-tts-container || true
          
          # Clean up Docker to free space
          docker system prune -a -f --volumes || true
          docker builder prune -a -f || true
          docker image prune -a -f || true
          docker container prune -f || true
          docker network prune -f || true
          
          # Clean up system space
          sudo apt clean || true
          sudo apt autoremove -y || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          
          # Clear Docker build cache and build new image
          docker builder prune -a -f || true
          docker build -t news-tts . --no-cache --pull
          
          # Run new container with environment variables
          docker run -d -p 8080:8080 --name news-tts-container --user root \
            -e HF_HOME=/home/app/.cache/huggingface \
            -e TRANSFORMERS_CACHE=/home/app/.cache/huggingface \
            -e HF_HUB_OFFLINE=0 \
            -e TRUST_REMOTE_CODE=1 \
            -e LOG_LEVEL=info \
            -e PORT=8080 \
            -e PYTHONUNBUFFERED=1 \
            news-tts
          
          # Wait for container to start
          sleep 10
          
          # Debug container status
          echo "=== Container Status ==="
          docker ps -a
          echo "=== Container Logs ==="
          docker logs news-tts-container
          echo "=== Container Processes ==="
          docker exec news-tts-container ps aux || echo "Cannot exec into container"
          
          # Check health
          curl -f http://localhost:8080/health || {
            echo "Health check failed - checking container logs"
            docker logs news-tts-container --tail 50
            exit 1
          }
          
          echo "Deployment successful!"
          echo "App URL: http://${{ secrets.VM_HOST }}:8080"
          echo "Health Check: http://${{ secrets.VM_HOST }}:8080/health"
