name: Deploy to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # VM Configuration
  VM_HOST: ${{ secrets.VM_HOST }}
  VM_USERNAME: ${{ secrets.VM_USERNAME }}
  IMAGE_NAME: news-tts
  
  # Non-sensitive defaults
  HF_HOME: /home/app/.cache/huggingface
  HF_HUB_CACHE: /home/app/.cache/huggingface/hub
  HF_HUB_OFFLINE: 0
  TRUST_REMOTE_CODE: 1
  TRANSLATION_PER_CALL_TIMEOUT: 90
  TRANSLATION_PER_CALL_TIMEOUT_RETRY: 120
  LOG_LEVEL: info
  PORT: 8080
  PYTHONUNBUFFERED: 1

  # Secrets from GitHub repository
  DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
  ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
  ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
  FIREBASE_SERVICE_ACCOUNT_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}
  FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
  MONGO_URI: ${{ secrets.MONGO_URI }}
  CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  
  # Azure Blob Storage
  AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
  AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
  AZURE_STORAGE_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_ACCESS_KEY }}
  AZURE_STORAGE_AUDIOFIELD_CONTAINER: ${{ secrets.AZURE_STORAGE_AUDIOFIELD_CONTAINER }}
  AZURE_STORAGE_MAGAZINE_CONTAINER: ${{ secrets.AZURE_STORAGE_MAGAZINE_CONTAINER }}
  AZURE_STORAGE_MAGAZINE2_CONTAINER: ${{ secrets.AZURE_STORAGE_MAGAZINE2_CONTAINER }}
  AZURE_STORAGE_OUTPUT_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_OUTPUT_CONTAINER_NAME }}
  
  # Azure Document Intelligence
  DOCINT_ENDPOINT: ${{ secrets.DOCINT_ENDPOINT }}
  DOCINT_KEY: ${{ secrets.DOCINT_KEY }}
  
  # Azure Cognitive Search
  AZURE_SEARCH_ENDPOINT: ${{ secrets.AZURE_SEARCH_ENDPOINT }}
  AZURE_SEARCH_KEY: ${{ secrets.AZURE_SEARCH_KEY }}
  AZURE_SEARCH_INDEX_NAME: ${{ secrets.AZURE_SEARCH_INDEX_NAME }}
  
  # Azure OpenAI
  AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
  AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
  AZURE_OPENAI_EMBED_MODEL: ${{ secrets.AZURE_OPENAI_EMBED_MODEL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        envs: DATABASE_NAME,ELEVENLABS_API_KEY,ELEVENLABS_VOICE_ID,FIREBASE_SERVICE_ACCOUNT_BASE64,FIREBASE_STORAGE_BUCKET,MONGO_URI,CORS_ORIGIN,AZURE_STORAGE_ACCOUNT_NAME,AZURE_STORAGE_CONNECTION_STRING,AZURE_STORAGE_ACCESS_KEY,AZURE_STORAGE_AUDIOFIELD_CONTAINER,AZURE_STORAGE_MAGAZINE_CONTAINER,AZURE_STORAGE_MAGAZINE2_CONTAINER,AZURE_STORAGE_OUTPUT_CONTAINER_NAME,DOCINT_ENDPOINT,DOCINT_KEY,AZURE_SEARCH_ENDPOINT,AZURE_SEARCH_KEY,AZURE_SEARCH_INDEX_NAME,AZURE_OPENAI_ENDPOINT,AZURE_OPENAI_KEY,AZURE_OPENAI_EMBED_MODEL,HF_HOME,HF_HUB_CACHE,HF_HUB_OFFLINE,TRUST_REMOTE_CODE,LOG_LEVEL,PORT,PYTHONUNBUFFERED,JWT_SECRET
        script: |
          # Navigate to project directory
          cd ~/news-tts
          
          # Stash local changes and pull latest changes
          git stash || true
          git pull origin main
          
          # Stop existing container
          docker stop news-tts-container || true
          docker rm news-tts-container || true
          
          # Clean up Docker to free space
          docker system prune -a -f --volumes || true
          docker builder prune -a -f || true
          docker image prune -a -f || true
          docker container prune -f || true
          docker network prune -f || true
          
          # Clean up system space
          sudo apt clean || true
          sudo apt autoremove -y || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          
          # Clear Docker build cache and build new image
          docker builder prune -a -f || true
          echo "Starting optimized Docker build..."
          docker build -t news-tts . --no-cache --pull
          
          # Run new container with environment variables (HTTP only - Nginx handles HTTPS)
          docker run -d -p 8080:8080 --name news-tts-container --user root \
            -e HF_HOME="$HF_HOME" \
            -e HF_HUB_CACHE="$HF_HUB_CACHE" \
            -e HF_HUB_OFFLINE="$HF_HUB_OFFLINE" \
            -e TRUST_REMOTE_CODE="$TRUST_REMOTE_CODE" \
            -e LOG_LEVEL="$LOG_LEVEL" \
            -e PORT="$PORT" \
            -e PYTHONUNBUFFERED="$PYTHONUNBUFFERED" \
            -e DATABASE_NAME="$DATABASE_NAME" \
            -e ELEVENLABS_API_KEY="$ELEVENLABS_API_KEY" \
            -e ELEVENLABS_VOICE_ID="$ELEVENLABS_VOICE_ID" \
            -e FIREBASE_SERVICE_ACCOUNT_BASE64="$FIREBASE_SERVICE_ACCOUNT_BASE64" \
            -e FIREBASE_STORAGE_BUCKET="$FIREBASE_STORAGE_BUCKET" \
            -e MONGO_URI="$MONGO_URI" \
            -e CORS_ORIGIN="$CORS_ORIGIN" \
            -e AZURE_STORAGE_ACCOUNT_NAME="$AZURE_STORAGE_ACCOUNT_NAME" \
            -e AZURE_STORAGE_CONNECTION_STRING="$AZURE_STORAGE_CONNECTION_STRING" \
            -e AZURE_STORAGE_ACCESS_KEY="$AZURE_STORAGE_ACCESS_KEY" \
            -e AZURE_STORAGE_AUDIOFIELD_CONTAINER="$AZURE_STORAGE_AUDIOFIELD_CONTAINER" \
            -e AZURE_STORAGE_MAGAZINE_CONTAINER="$AZURE_STORAGE_MAGAZINE_CONTAINER" \
            -e AZURE_STORAGE_MAGAZINE2_CONTAINER="$AZURE_STORAGE_MAGAZINE2_CONTAINER" \
            -e AZURE_STORAGE_OUTPUT_CONTAINER_NAME="$AZURE_STORAGE_OUTPUT_CONTAINER_NAME" \
            -e DOCINT_ENDPOINT="$DOCINT_ENDPOINT" \
            -e DOCINT_KEY="$DOCINT_KEY" \
            -e AZURE_SEARCH_ENDPOINT="$AZURE_SEARCH_ENDPOINT" \
            -e AZURE_SEARCH_KEY="$AZURE_SEARCH_KEY" \
            -e AZURE_SEARCH_INDEX_NAME="$AZURE_SEARCH_INDEX_NAME" \
            -e AZURE_OPENAI_ENDPOINT="$AZURE_OPENAI_ENDPOINT" \
            -e AZURE_OPENAI_KEY="$AZURE_OPENAI_KEY" \
            -e AZURE_OPENAI_EMBED_MODEL="$AZURE_OPENAI_EMBED_MODEL" \
            -e JWT_SECRET="$JWT_SECRET" \
            news-tts
          
          # Wait for container to start
          sleep 10
          
          # Debug container status
          echo "=== Container Status ==="
          docker ps -a
          echo "=== Container Logs ==="
          docker logs news-tts-container
          echo "=== Container Processes ==="
          docker exec news-tts-container ps aux || echo "Cannot exec into container"
          
          # Check health
          curl -f http://localhost:8080/health || {
            echo "Health check failed - checking container logs"
            docker logs news-tts-container --tail 50
            exit 1
          }
          
          echo "Deployment successful!"